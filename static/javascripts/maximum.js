// Generated by CoffeeScript 1.4.0
(function() {
  var MaximumIdol,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  MaximumIdol = (function() {

    function MaximumIdol() {
      this.randomize = __bind(this.randomize, this);

      var _this = this;
      this.stack = [];
      this.elements = {
        body: $(document.body)
      };
      this.elements.body.addClass('onready');
      $(window).load(function() {
        if (_this.elements.body.hasClass('loading')) {
          return _this.elements.body.removeClass('loading').addClass('loaded');
        }
      });
      this.navigate();
      this.buffer();
    }

    MaximumIdol.prototype.preload = function(url) {
      var image;
      image = new Image();
      return image.src = url;
    };

    MaximumIdol.prototype.buffer = function() {
      var i, _i, _ref, _results,
        _this = this;
      _results = [];
      for (i = _i = 0, _ref = 2 - this.stack.length; _i <= _ref; i = _i += 1) {
        _results.push($.getJSON('/fetch?' + i, function(data) {
          _this.stack.push({
            url: data.idol
          });
          _this.preload(data.idol);
          console.log('adding ' + data.idol);
          return console.log(_this.stack);
        }));
      }
      return _results;
    };

    MaximumIdol.prototype.navigate = function() {
      var _this = this;
      console.log('navigated!');
      return $('body').on('click', 'a.gif', function(e) {
        _this.randomize();
        return e.preventDefault();
      });
    };

    MaximumIdol.prototype.randomize = function() {
      var _this = this;
      console.log('randomized!');
      if (this.stack.length > 0) {
        this.update(this.stack[0].url);
        this.stack.splice(0, 1);
        return this.buffer();
      } else {
        $.getJSON('/fetch', function(data) {
          return _this.update(data.idol);
        }).error(function() {
          return window.location.href = '/random';
        });
        return this.buffer();
      }
    };

    MaximumIdol.prototype.update = function(newURL) {
      var newGif, oldGif;
      oldGif = $('a.gif');
      newGif = oldGif.clone();
      newGif.addClass('new-gif').css('backgroundImage', 'url(\'' + newURL + '\')');
      oldGif.addClass('old-gif').before(newGif);
      oldGif.fadeOut(150, function() {
        oldGif.detach();
        return newGif.removeClass('new-gif');
      });
      _gauges.push(['track']);
      return _gaq.push(['_trackPageview', '/']);
    };

    return MaximumIdol;

  })();

  $(window).ready(function() {
    return new MaximumIdol;
  });

}).call(this);
